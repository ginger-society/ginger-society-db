name: Build, Push Docker Image, and Restart Deployment

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Migrate for IAM DB
      working-directory: ./IAM
      run: |
        echo "Starting migration for IAM DB"
        docker run \
          -e DB_HOST=${{ secrets.DB_HOST }} \
          -e DB_PORT=${{ secrets.DB_PORT }} \
          -e DB_USERNAME=${{ secrets.DB_USERNAME }} \
          -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
          -e DB_NAME=${{ secrets.DB_NAME_ONE }} \
          -v $(pwd)/models.py:/app/src/models.py \
          -v $(pwd)/admin.py:/app/src/admin.py \
          -v $(pwd)/migrations:/app/src/migrations \
          gingersociety/db-compose-migrator:latest

    - name: Migrate for Metadata DB
      working-directory: ./metadata
      run: |
        echo "Starting migration for Metadata DB"
        docker run \
          -e DB_HOST=${{ secrets.DB_HOST }} \
          -e DB_PORT=${{ secrets.DB_PORT }} \
          -e DB_USERNAME=${{ secrets.DB_USERNAME }} \
          -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
          -e DB_NAME=${{ secrets.DB_NAME_TWO }} \
          -v $(pwd)/models.py:/app/src/models.py \
          -v $(pwd)/admin.py:/app/src/admin.py \
          -v $(pwd)/migrations:/app/src/migrations \
          gingersociety/db-compose-migrator:latest
